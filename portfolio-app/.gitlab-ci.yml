image: node:22

stages:
  - build
  - test
  - deploy

variables:
  NODE_VERSION: "22.x"
  AWS_REGION: "us-east-1"
  CACHE_DEPENDENCIES: "portfolio-app/node_modules"

cache:
  paths:
    - portfolio-app/node_modules/

before_script:
  - cd portfolio-app
  - npm ci

build:
  stage: build
  script:
    - npm run build -- --configuration=production
  artifacts:
    paths:
      - portfolio-app/dist/
    expire_in: 1 week
  only:
    - main
    - master
    - develop
    - merge_requests

test:
  stage: test
  script:
    - npm run lint || true
    - npm test -- --watch=false --browsers=ChromeHeadless
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: portfolio-app/coverage/cobertura-coverage.xml
  only:
    - main
    - master
    - develop
    - merge_requests

deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client sshpass
    - eval $(ssh-agent -s)
    - echo "$EC2_SSH_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
  script:
    - cd portfolio-app
    - |
      ssh $EC2_USER@$EC2_HOST '
        sudo systemctl stop nginx || true
        sudo rm -rf /var/www/portfolio-app/backup || true
        sudo mv /var/www/portfolio-app /var/www/portfolio-app.backup || true
        sudo mkdir -p /var/www/portfolio-app
      '
    - scp -r dist/portfolio-app/* $EC2_USER@$EC2_HOST:/var/www/portfolio-app/
    - |
      ssh $EC2_USER@$EC2_HOST '
        sudo systemctl start nginx
        echo "Deployment completed successfully"
      '
  environment:
    name: production
    url: https://www.grayson-wills.com
  only:
    - main
    - master
  when: manual
  variables:
    EC2_HOST: $EC2_HOST
    EC2_USER: $EC2_USER
    EC2_SSH_KEY: $EC2_SSH_PRIVATE_KEY

deploy_staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$EC2_SSH_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $EC2_STAGING_HOST >> ~/.ssh/known_hosts
  script:
    - cd portfolio-app
    - scp -r dist/portfolio-app/* $EC2_USER@$EC2_STAGING_HOST:/var/www/portfolio-app-staging/
  environment:
    name: staging
    url: https://staging.grayson-wills.com
  only:
    - develop
  when: manual
