name: Security Scans

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Weekly (Mon 13:00 UTC) to catch new dependency CVEs even without commits.
    - cron: "0 13 * * 1"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  gitleaks:
    name: Secret Scan (gitleaks)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        with:
          report_format: sarif
          report_path: gitleaks.sarif
      - name: Upload SARIF
        if: ${{ always() && hashFiles('gitleaks.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif

  codeql:
    name: SAST (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ["javascript-typescript"]
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
      - uses: github/codeql-action/analyze@v3

  npm_audit:
    name: Dependency Audit (npm)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pkg:
          - portfolio-app
          - blog-authoring-gui
          - redis-api-server
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: npm
          cache-dependency-path: ${{ matrix.pkg }}/package-lock.json
      - name: Install
        working-directory: ${{ matrix.pkg }}
        run: npm ci
      - name: Audit production deps (fail on high/critical)
        working-directory: ${{ matrix.pkg }}
        run: npm audit --omit=dev --audit-level=high
