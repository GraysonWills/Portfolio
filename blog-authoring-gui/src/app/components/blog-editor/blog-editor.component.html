<div class="blog-editor-container">
  <p-card class="editor-card">
    <div class="editor-header">
      <h2>{{ initialData ? 'Edit Blog Post' : 'Create New Blog Post' }}</h2>
    </div>

    <form [formGroup]="blogForm" class="editor-form">
      <div class="editor-workspace">
        <section class="editor-main-column">
          <!-- Title -->
          <div class="form-group main-field main-field-card main-field-title">
            <label for="title">Title *</label>
            <input 
              type="text" 
              id="title" 
              formControlName="title"
              pInputText
              placeholder="Enter blog post title"
              class="full-width">
            <small *ngIf="blogForm.get('title')?.invalid && blogForm.get('title')?.touched" class="error-message">
              Title is required
            </small>
          </div>

          <!-- Summary -->
          <div class="form-group main-field main-field-card main-field-summary">
            <label for="summary">Summary *</label>
            <textarea 
              id="summary" 
              formControlName="summary"
              rows="3"
              placeholder="Enter a brief summary"
              class="full-width summary-textarea"
              pInputText>
            </textarea>
            <small *ngIf="blogForm.get('summary')?.invalid && blogForm.get('summary')?.touched" class="error-message">
              Summary is required
            </small>
          </div>

          <!-- Content Editor -->
          <div class="form-group main-field main-field-card main-field-content">
            <label for="content">Content *</label>
            <p-editor 
              formControlName="content"
              [modules]="editorModules"
              [formats]="editorFormats"
              [style]="{'height':'420px'}"
              (onInit)="onEditorInit($event)"
              placeholder="Write your blog post content here...">
            </p-editor>
            <small class="help-text">Paste from other pages to retain most rich formatting (headings, lists, links, colors, alignment).</small>
            <small *ngIf="blogForm.get('content')?.invalid && blogForm.get('content')?.touched" class="error-message">
              Content is required
            </small>
          </div>
        </section>

        <aside class="editor-side-column">
          <!-- Image Upload -->
          <div class="form-group side-card">
            <label>Featured Image</label>
            <app-image-uploader 
              (imageUploaded)="uploadedImage = $event"
              [currentImage]="uploadedImage">
            </app-image-uploader>
            <div class="image-actions">
              <p-button
                label="Insert In Post Body"
                icon="pi pi-arrow-down"
                (onClick)="insertFeaturedImageIntoContent()"
                [disabled]="!uploadedImage"
                styleClass="p-button-sm p-button-outlined full-width">
              </p-button>
            </div>
            <small class="help-text">Upload once, then insert inline at the cursor for quick visual layout checks.</small>
          </div>

          <!-- Public Tags -->
          <div class="form-group side-card">
            <label>Public Tags</label>
            <div class="tags-input">
              <input 
                type="text" 
                [(ngModel)]="currentPublicTag"
                (ngModelChange)="onPublicTagInputChange($event)"
                (keydown.enter)="addPublicTags($event)"
                pInputText
                placeholder="Type tags separated by commas"
                [ngModelOptions]="{standalone: true}"
                class="tag-input">
              <p-button 
                label="Add" 
                icon="pi pi-plus"
                (onClick)="addPublicTags()"
                styleClass="p-button-outlined">
              </p-button>
            </div>
            <small class="help-text">Visible to readers on cards and post pages.</small>
            <div class="tags-list" *ngIf="publicTags.length > 0">
              <p-tag 
                *ngFor="let tag of publicTags" 
                [value]="tag"
                styleClass="p-mr-1">
                <span>{{ tag }}</span>
                <i class="pi pi-times tag-remove" (click)="removePublicTag(tag)"></i>
              </p-tag>
            </div>
          </div>

          <!-- Private SEO Tags -->
          <div class="form-group side-card">
            <label>Private SEO Tags</label>
            <div class="tags-input">
              <input
                type="text"
                [(ngModel)]="currentPrivateSeoTag"
                (ngModelChange)="onPrivateSeoTagInputChange($event)"
                (keydown.enter)="addPrivateSeoTags($event)"
                pInputText
                placeholder="Type SEO tags separated by commas"
                [ngModelOptions]="{standalone: true}"
                class="tag-input">
              <p-button
                label="Add"
                icon="pi pi-plus"
                (onClick)="addPrivateSeoTags()"
                styleClass="p-button-outlined">
              </p-button>
            </div>
            <small class="help-text">Hidden from readers; used only for search indexing metadata.</small>
            <div class="tags-list" *ngIf="privateSeoTags.length > 0">
              <p-tag
                *ngFor="let tag of privateSeoTags"
                [value]="tag"
                severity="secondary"
                styleClass="p-mr-1">
                <span>{{ tag }}</span>
                <i class="pi pi-times tag-remove" (click)="removePrivateSeoTag(tag)"></i>
              </p-tag>
            </div>
          </div>

          <div class="form-group side-card">
            <label for="signatureId">Post Signature</label>
            <p-dropdown
              formControlName="signatureId"
              [options]="getSignatureOptions()"
              optionLabel="label"
              optionValue="value"
              placeholder="Choose signature"
              inputId="signatureId"
              appendTo="body"
              styleClass="full-width">
            </p-dropdown>
            <small class="help-text">Select quote/sign-off for this post. Leaving it blank uses the default signature.</small>
          </div>

          <div class="form-group side-card signature-library-card">
            <label>Signature Library</label>
            <div class="signature-list" *ngIf="signatureSettings.signatures.length; else noSignatures">
              <div class="signature-item" *ngFor="let sig of signatureSettings.signatures">
                <div class="signature-item-header">
                  <strong>{{ sig.label }}</strong>
                  <span class="default-pill" *ngIf="isDefaultSignature(sig.id)">Default</span>
                </div>
                <p class="signature-quote">"{{ sig.quote }}"</p>
                <p class="signature-meta">— {{ sig.quoteAuthor }}</p>
                <p class="signature-signoff">{{ sig.signOffName }}</p>
                <div class="signature-item-actions">
                  <p-button
                    label="Set Default"
                    icon="pi pi-star"
                    (onClick)="setDefaultSignature(sig.id)"
                    [disabled]="isDefaultSignature(sig.id) || savingSignatureSettings"
                    styleClass="p-button-text p-button-sm">
                  </p-button>
                  <p-button
                    label="Delete"
                    icon="pi pi-trash"
                    (onClick)="removeSignaturePreset(sig.id)"
                    [disabled]="savingSignatureSettings"
                    styleClass="p-button-text p-button-sm p-button-danger">
                  </p-button>
                </div>
              </div>
            </div>
            <ng-template #noSignatures>
              <small class="help-text">No signatures configured yet.</small>
            </ng-template>

            <div class="signature-create">
              <input
                type="text"
                pInputText
                [(ngModel)]="draftSignatureLabel"
                [ngModelOptions]="{standalone: true}"
                placeholder="Label (optional)">
              <textarea
                pInputText
                [(ngModel)]="draftSignatureQuote"
                [ngModelOptions]="{standalone: true}"
                rows="3"
                placeholder="Quote">
              </textarea>
              <input
                type="text"
                pInputText
                [(ngModel)]="draftSignatureAuthor"
                [ngModelOptions]="{standalone: true}"
                placeholder="Quote author">
              <input
                type="text"
                pInputText
                [(ngModel)]="draftSignatureName"
                [ngModelOptions]="{standalone: true}"
                placeholder="Sign-off name (e.g., Grayson Wills)">
              <p-button
                label="Add Signature"
                icon="pi pi-plus"
                (onClick)="addSignaturePreset()"
                [loading]="savingSignatureSettings"
                styleClass="p-button-sm">
              </p-button>
            </div>
          </div>

          <!-- Publish Date and Status -->
          <div class="form-row side-card">
            <div class="form-group">
              <label for="publishDate">Publish Date</label>
              <p-calendar 
                formControlName="publishDate"
                [showTime]="true"
                dateFormat="mm/dd/yy"
                inputId="publishDate"
                appendTo="body"
                styleClass="full-width">
              </p-calendar>
            </div>

            <div class="form-group">
              <label for="status">Status</label>
              <p-dropdown 
                formControlName="status"
                [options]="statusOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="Select status"
                inputId="status"
                appendTo="body"
                styleClass="full-width">
              </p-dropdown>
            </div>
          </div>

          <!-- Notifications -->
          <div class="form-group side-card">
            <label>Email Update</label>
            <p-toggleButton
              formControlName="sendEmailUpdate"
              onLabel="Email: On"
              offLabel="Email: Off"
              onIcon="pi pi-envelope"
              offIcon="pi pi-envelope"
              styleClass="full-width">
            </p-toggleButton>
            <small class="help-text">
              If enabled: published posts notify subscribers immediately, and scheduled posts send at publish time.
            </small>
          </div>

          <!-- Category -->
          <div class="form-group side-card">
            <label for="category">Category</label>
            <input 
              type="text" 
              id="category" 
              formControlName="category"
              pInputText
              placeholder="Enter category (optional)">
          </div>
        </aside>
      </div>

      <!-- Actions -->
      <div class="editor-actions">
        <p-button
          label="Preview on Site (Card)"
          icon="pi pi-external-link"
          (onClick)="openPortfolioPreview('list')"
          styleClass="p-button-outlined">
        </p-button>
        <p-button
          label="Preview on Site (Full)"
          icon="pi pi-external-link"
          (onClick)="openPortfolioPreview('post')"
          styleClass="p-button-outlined">
        </p-button>
        <p-button
          label="Preview Card"
          icon="pi pi-image"
          (onClick)="openPreview('card')"
          styleClass="p-button-outlined">
        </p-button>
        <p-button
          label="Preview Full Post"
          icon="pi pi-eye"
          (onClick)="openPreview('full')"
          styleClass="p-button-outlined">
        </p-button>
        <p-button 
          label="Cancel" 
          icon="pi pi-times"
          (onClick)="cancel()"
          styleClass="p-button-outlined">
        </p-button>
        <p-button 
          label="Save Post" 
          icon="pi pi-save"
          (onClick)="savePost()"
          [disabled]="blogForm.invalid || isSaving"
          [loading]="isSaving"
          styleClass="p-button-primary">
        </p-button>
      </div>
    </form>
  </p-card>

  <p-dialog
    [(visible)]="showPreviewDialog"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [dismissableMask]="true"
    [style]="{ width: 'min(980px, 94vw)' }"
    [header]="'Preview: ' + (previewMode === 'card' ? 'Title Card' : 'Full Post')">
    <div class="preview-toolbar">
      <p-button
        label="Title Card"
        icon="pi pi-image"
        (onClick)="setPreviewMode('card')"
        [styleClass]="previewMode === 'card' ? 'p-button-sm' : 'p-button-sm p-button-outlined'">
      </p-button>
      <p-button
        label="Full Post"
        icon="pi pi-eye"
        (onClick)="setPreviewMode('full')"
        [styleClass]="previewMode === 'full' ? 'p-button-sm' : 'p-button-sm p-button-outlined'">
      </p-button>
    </div>

    <section *ngIf="previewMode === 'card'" class="preview-card-frame">
      <div class="preview-card-media" *ngIf="getPreviewImage() as imageUrl">
        <img [src]="imageUrl" [alt]="getPreviewTitle() + ' cover image'" loading="lazy" />
      </div>
      <div class="preview-card-content">
        <div class="preview-card-meta">
          <span><i class="pi pi-calendar"></i> {{ getPreviewPublishDate() | date:'mediumDate' }}</span>
          <span><i class="pi pi-clock"></i> {{ getPreviewReadTimeMinutes() }} min read</span>
          <span><i class="pi pi-bookmark"></i> {{ getPreviewStatus() }}</span>
        </div>
        <h3>{{ getPreviewTitle() }}</h3>
        <p>{{ getPreviewSummary() }}</p>
        <div class="preview-tags" *ngIf="getPreviewTags().length > 0">
          <p-tag *ngFor="let tag of getPreviewTags()" [value]="tag"></p-tag>
        </div>
      </div>
    </section>

    <article *ngIf="previewMode === 'full'" class="preview-post">
      <div class="preview-hero" *ngIf="getPreviewImage() as imageUrl">
        <img [src]="imageUrl" [alt]="getPreviewTitle() + ' hero image'" loading="lazy" />
      </div>
      <header class="preview-post-header">
        <h1>{{ getPreviewTitle() }}</h1>
        <p class="preview-post-summary">{{ getPreviewSummary() }}</p>
        <div class="preview-card-meta">
          <span><i class="pi pi-calendar"></i> {{ getPreviewPublishDate() | date:'mediumDate' }}</span>
          <span><i class="pi pi-clock"></i> {{ getPreviewReadTimeMinutes() }} min read</span>
          <span><i class="pi pi-bookmark"></i> {{ getPreviewStatus() }}</span>
        </div>
        <div class="preview-tags" *ngIf="getPreviewTags().length > 0">
          <p-tag *ngFor="let tag of getPreviewTags()" [value]="tag"></p-tag>
        </div>
      </header>
      <div class="preview-post-body" [innerHTML]="getPreviewContentHtml()"></div>
      <section *ngIf="getPreviewSignature() as signature" class="preview-signature">
        <p class="preview-signature-quote">"{{ signature.quote }}"</p>
        <p class="preview-signature-author">— {{ signature.quoteAuthor }}</p>
        <p class="preview-signature-name">{{ signature.signOffName }}</p>
      </section>
    </article>
  </p-dialog>
</div>
